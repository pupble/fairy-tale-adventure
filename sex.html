<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸŒ™ æ‹çˆ±æ·±å¤œé£Ÿå ‚ | Love Bistro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Nunito:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* --- å…¨å±€æ ·å¼ --- */
    body {
        font-family: 'Nunito', 'ZCOOL KuaiLe', sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #2e1a2e 100%);
        color: #fff;
        overflow: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* åŠ¨æ€èƒŒæ™¯ */
    .bg-particles {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-image: 
            radial-gradient(circle at 20% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 20%),
            radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 20%);
        animation: pulseBg 10s infinite alternate;
        z-index: -1;
    }
    @keyframes pulseBg { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

    /* ç»ç’ƒæ‹Ÿæ€å¡ç‰‡ */
    .glass-panel {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    .glass-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.2); }

    /* å­—ä½“ */
    .cute-font { font-family: 'ZCOOL KuaiLe', cursive; }

    /* éšè—æ»šåŠ¨æ¡ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- åŠ¨ç”»ç±» --- */
    /* å”±ç‰‡æ—‹è½¬ */
    .spin-slow { animation: spin 8s linear infinite; }
    .spin-paused { animation-play-state: paused; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* å…”å­åŠ¨ç”» */
    .rabbit-ear-l { animation: earWiggle 3s ease-in-out infinite; transform-origin: bottom right; }
    .rabbit-ear-r { animation: earWiggle 3s ease-in-out infinite reverse; transform-origin: bottom left; }
    @keyframes earWiggle { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(5deg); } }
    
    .float-anim { animation: float 4s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

    /* éŸ³æ³¢è·³åŠ¨ */
    .bar {
        width: 4px; background: #F472B6; margin: 0 2px;
        animation: sound 0s infinite alternate;
        border-radius: 4px;
    }
    .bar-playing { animation-duration: 0.4s; }
    @keyframes sound { 0% { height: 5px; opacity: 0.5; } 100% { height: 25px; opacity: 1; } }

    /* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
    .view-container { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s; }
    .view-hidden { transform: scale(0.95); opacity: 0; pointer-events: none; position: absolute; }
    .view-active { transform: scale(1); opacity: 1; pointer-events: auto; position: relative; }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .input-glass {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
    }
    .input-glass:focus { border-color: #F472B6; outline: none; }
</style>
</head>
<body class="h-screen w-screen flex items-center justify-center p-0 md:p-4 text-white">

<div class="bg-particles"></div>

<!-- ä¸»å®¹å™¨ -->
<div class="w-full h-full md:h-[800px] md:max-w-[420px] glass-panel md:rounded-[3rem] relative flex flex-col overflow-hidden shadow-2xl">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="h-16 flex items-center justify-between px-6 z-20 shrink-0 border-b border-white/5">
        <button onclick="goHome()" class="text-white/70 hover:text-pink-400 transition text-lg"><i class="fa-solid fa-house"></i></button>
        <h1 class="text-xl cute-font tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-pink-300 to-purple-300">
            ğŸŒ™ æ·±å¤œå°é£Ÿå ‚
        </h1>
        <button onclick="toggleSettings()" class="text-white/70 hover:text-pink-400 transition text-lg"><i class="fa-solid fa-sliders"></i></button>
    </header>

    <!-- è®¾ç½®é¢æ¿ (API Key) -->
    <div id="settings-panel" class="hidden absolute top-16 left-0 right-0 bg-gray-900/95 backdrop-blur-xl p-6 z-50 border-b border-white/10 shadow-2xl transform transition-all">
        <h3 class="text-sm font-bold text-gray-300 mb-3">å¨å¸ˆé•¿é€šé“ (API è®¾ç½®)</h3>
        <p class="text-xs text-gray-400 mb-2">è¾“å…¥ DeepSeek/OpenAI Key ä»¥æ¿€æ´» AI å®šåˆ¶èœå•åŠŸèƒ½ï¼Œå¦åˆ™ä½¿ç”¨æœ¬åœ°éšæœºæ¨èã€‚</p>
        <input type="password" id="api-key" class="w-full input-glass rounded-lg p-3 text-sm mb-4" placeholder="sk-...">
        <div class="flex justify-end gap-3">
            <button onclick="toggleSettings()" class="text-xs text-gray-400 px-2">å…³é—­</button>
            <button onclick="saveSettings()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 relative w-full h-full overflow-hidden">
        
        <!-- 1. é¦–é¡µ (Landing) -->
        <div id="view-home" class="view-container view-active w-full h-full flex flex-col items-center justify-center p-6 text-center">
            
            <!-- å…”å­ SVG -->
            <div class="w-48 h-48 relative mb-8 float-anim group cursor-pointer" onclick="pokeRabbit()">
                <div class="absolute inset-0 bg-pink-500/20 blur-3xl rounded-full"></div>
                <svg viewBox="0 0 200 200" class="relative z-10 drop-shadow-lg">
                    <!-- è€³æœµ -->
                    <path class="rabbit-ear-l" d="M70 80 Q 50 10 70 0 Q 90 10 80 80" fill="#FCE7F3" stroke="#FBCFE8" stroke-width="2"/>
                    <path class="rabbit-ear-r" d="M130 80 Q 150 10 130 0 Q 110 10 120 80" fill="#FCE7F3" stroke="#FBCFE8" stroke-width="2"/>
                    <!-- å¤´ -->
                    <circle cx="100" cy="110" r="50" fill="#FFF0F5" />
                    <!-- å¨å¸ˆå¸½ -->
                    <path d="M80 70 Q 70 40 100 35 Q 130 40 120 70 Z" fill="#fff" stroke="#eee" stroke-width="2"/>
                    <path d="M80 70 L 120 70 L 115 85 L 85 85 Z" fill="#eee"/>
                    <!-- è„¸ -->
                    <circle cx="85" cy="105" r="4" fill="#374151"/>
                    <circle cx="115" cy="105" r="4" fill="#374151"/>
                    <path d="M95 115 L 105 115 L 100 120 Z" fill="#FDA4AF"/>
                    <path d="M100 120 Q 90 130 85 120 M 100 120 Q 110 130 115 120" fill="none" stroke="#374151" stroke-width="2"/>
                    <!-- è…®çº¢ -->
                    <circle cx="75" cy="118" r="5" fill="#FDA4AF" opacity="0.4"/>
                    <circle cx="125" cy="118" r="5" fill="#FDA4AF" opacity="0.4"/>
                </svg>
                <div id="bubble" class="absolute -top-4 -right-2 bg-white text-gray-800 text-xs px-3 py-1.5 rounded-t-xl rounded-br-xl rounded-bl-none font-bold opacity-0 transition-opacity duration-300">
                    æ¬¢è¿å…‰ä¸´~
                </div>
            </div>

            <h2 class="text-2xl cute-font mb-2">ä»Šæ™šæƒ³ç‚¹ä»€ä¹ˆèœï¼Ÿ</h2>
            <p class="text-white/60 text-sm mb-8 px-8">â€œè¿™é‡Œä¸å–çœŸæ­£çš„é¥­ï¼Œåªè´©å–æµªæ¼«ä¸å¤šå·´èƒºã€‚â€</p>

            <div class="grid grid-cols-2 gap-4 w-full">
                <button onclick="switchView('view-music')" class="glass-btn p-4 rounded-2xl flex flex-col items-center gap-2 group">
                    <div class="w-10 h-10 rounded-full bg-purple-500/30 flex items-center justify-center text-purple-300 group-hover:bg-purple-500 group-hover:text-white transition">
                        <i class="fa-solid fa-music"></i>
                    </div>
                    <span class="text-sm font-bold">æ°›å›´éŸ³ä¹</span>
                </button>
                <button onclick="switchView('view-recipe')" class="glass-btn p-4 rounded-2xl flex flex-col items-center gap-2 group">
                    <div class="w-10 h-10 rounded-full bg-pink-500/30 flex items-center justify-center text-pink-300 group-hover:bg-pink-500 group-hover:text-white transition">
                        <i class="fa-solid fa-book-open"></i>
                    </div>
                    <span class="text-sm font-bold">å§¿åŠ¿å›¾é‰´</span>
                </button>
                <button onclick="switchView('view-tips')" class="glass-btn p-4 rounded-2xl flex flex-col items-center gap-2 group">
                    <div class="w-10 h-10 rounded-full bg-blue-500/30 flex items-center justify-center text-blue-300 group-hover:bg-blue-500 group-hover:text-white transition">
                        <i class="fa-solid fa-flask"></i>
                    </div>
                    <span class="text-sm font-bold">å®‰å…¨ç§‘æ™®</span>
                </button>
                <button onclick="switchView('view-ai')" class="glass-btn p-4 rounded-2xl flex flex-col items-center gap-2 group border-pink-400/30">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-pink-500 to-orange-400 flex items-center justify-center text-white group-hover:scale-110 transition">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <span class="text-sm font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-300 to-orange-300">AI å®šåˆ¶èœå•</span>
                </button>
            </div>
        </div>

        <!-- 2. æ°›å›´éŸ³ä¹ (Music) -->
        <div id="view-music" class="view-container view-hidden absolute inset-0 flex flex-col items-center p-6 pt-10">
            <h3 class="cute-font text-xl mb-6 text-pink-300">ğŸ§ æ°›å›´è°ƒéŸ³å°</h3>
            
            <!-- å”±ç‰‡æœº UI -->
            <div class="relative w-64 h-64 mb-8">
                <!-- å”±ç‰‡èƒŒæ™¯ -->
                <div class="absolute inset-0 rounded-full bg-gray-800 border-4 border-gray-700 shadow-xl flex items-center justify-center overflow-hidden">
                    <div id="vinyl-record" class="w-[95%] h-[95%] rounded-full bg-[url('https://www.transparenttextures.com/patterns/black-vinyl.png')] bg-gray-900 shadow-inner flex items-center justify-center spin-slow spin-paused transition-all relative">
                        <!-- å”±ç‰‡çº¹ç† -->
                        <div class="absolute inset-0 rounded-full border border-gray-700 opacity-50" style="transform: scale(0.9)"></div>
                        <div class="absolute inset-0 rounded-full border border-gray-700 opacity-50" style="transform: scale(0.75)"></div>
                        <div class="absolute inset-0 rounded-full border border-gray-700 opacity-50" style="transform: scale(0.6)"></div>
                        <!-- å°é¢ -->
                        <div id="album-art" class="w-24 h-24 rounded-full bg-gradient-to-br from-pink-400 to-purple-600 flex items-center justify-center overflow-hidden relative z-10">
                            <i class="fa-solid fa-music text-white/50 text-3xl"></i>
                        </div>
                    </div>
                </div>
                <!-- å”±è‡‚ -->
                <div id="tone-arm" class="absolute -top-4 -right-4 w-8 h-32 origin-top bg-transparent transition-transform duration-500" style="transform: rotate(-30deg)">
                    <div class="w-2 h-24 bg-gray-400 mx-auto rounded-full shadow-lg relative">
                        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-8 bg-gray-600 rounded"></div>
                    </div>
                </div>
            </div>

            <!-- å½“å‰æ’­æ”¾ä¿¡æ¯ -->
            <div class="text-center mb-8 h-16">
                <h4 id="track-name" class="text-lg font-bold">é€‰æ‹©ä¸€å¼ å”±ç‰‡</h4>
                <div id="visualizer" class="flex justify-center items-end h-6 gap-1 mt-2 opacity-0 transition-opacity">
                    <div class="bar" style="animation-delay: 0s"></div>
                    <div class="bar" style="animation-delay: 0.1s"></div>
                    <div class="bar" style="animation-delay: 0.2s"></div>
                    <div class="bar" style="animation-delay: 0.3s"></div>
                    <div class="bar" style="animation-delay: 0.1s"></div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="flex gap-4 w-full overflow-x-auto no-scrollbar pb-4 px-2">
                <button onclick="playMusic('rnb')" class="shrink-0 glass-btn px-4 py-3 rounded-xl flex items-center gap-2 hover:bg-white/10">
                    <div class="w-8 h-8 rounded bg-pink-500 flex items-center justify-center"><i class="fa-solid fa-wine-glass"></i></div>
                    <div class="text-left"><div class="text-xs text-gray-400">R&B</div><div class="text-sm font-bold">å¾®é†ºå‰å¥</div></div>
                </button>
                <button onclick="playMusic('jazz')" class="shrink-0 glass-btn px-4 py-3 rounded-xl flex items-center gap-2 hover:bg-white/10">
                    <div class="w-8 h-8 rounded bg-indigo-500 flex items-center justify-center"><i class="fa-solid fa-saxophone"></i></div>
                    <div class="text-left"><div class="text-xs text-gray-400">Jazz</div><div class="text-sm font-bold">æ…µæ‡’æ·±çº¢</div></div>
                </button>
                <button onclick="playMusic('lofi')" class="shrink-0 glass-btn px-4 py-3 rounded-xl flex items-center gap-2 hover:bg-white/10">
                    <div class="w-8 h-8 rounded bg-teal-500 flex items-center justify-center"><i class="fa-solid fa-cloud"></i></div>
                    <div class="text-left"><div class="text-xs text-gray-400">Lo-Fi</div><div class="text-sm font-bold">æ¸©æŸ”äº‹å</div></div>
                </button>
            </div>
            
            <!-- éšè—çš„ Audio å…ƒç´  (ç”¨äºæ’­æ”¾å ä½å£°æ•ˆ) -->
            <audio id="audio-player" loop></audio>
        </div>

        <!-- 3. å§¿åŠ¿å›¾é‰´ (Recipes) -->
        <div id="view-recipe" class="view-container view-hidden absolute inset-0 flex flex-col p-6">
            <h3 class="cute-font text-xl mb-4 text-center text-pink-300">ğŸ“– éšè—èœå•</h3>
            
            <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar shrink-0">
                <button onclick="filterRecipe('all')" class="px-4 py-1.5 rounded-full bg-white/20 text-xs font-bold hover:bg-white/30 transition">å…¨éƒ¨</button>
                <button onclick="filterRecipe('easy')" class="px-4 py-1.5 rounded-full bg-green-500/20 text-green-300 text-xs font-bold border border-green-500/30">æ–°æ‰‹æ‘ ğŸŸ¢</button>
                <button onclick="filterRecipe('hard')" class="px-4 py-1.5 rounded-full bg-red-500/20 text-red-300 text-xs font-bold border border-red-500/30">æ‚æŠ€å›¢ ğŸ”´</button>
            </div>

            <div id="recipe-list" class="flex-1 overflow-y-auto no-scrollbar space-y-3 pb-6">
                <!-- ç”± JS åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- 4. ç§‘æ™® (Tips) -->
        <div id="view-tips" class="view-container view-hidden absolute inset-0 flex flex-col p-6">
            <h3 class="cute-font text-xl mb-4 text-center text-blue-300">ğŸ§ª å¨æˆ¿å®‰å…¨å®ˆåˆ™</h3>
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-4 pb-6">
                
                <div class="glass-panel p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fa-solid fa-shield-cat text-blue-400 text-xl"></i>
                        <h4 class="font-bold text-blue-200">å…³äºã€Œé›¨è¡£ã€çš„é€‰æ‹©</h4>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed">åˆ«åªçœ‹è¶…è–„ã€‚å°ºå¯¸æ›´é‡è¦ï¼è¿‡ç´§å®¹æ˜“ç ´ï¼Œè¿‡æ¾å®¹æ˜“æ‰ã€‚å°±åƒåšé¥­é€‰é”…ç›–ï¼Œå¿…é¡»ä¸¥ä¸åˆç¼æ‰èƒ½ç„–å‡ºå¥½ç±³é¥­ã€‚è®°å¾—è¦ææ‰å‚¨ç²¾å›Šçš„ç©ºæ°”å“¦ã€‚</p>
                </div>

                <div class="glass-panel p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fa-solid fa-oil-can text-yellow-400 text-xl"></i>
                        <h4 class="font-bold text-yellow-200">æ¶¦æ»‘æ˜¯ç¬¬ä¸€ç”Ÿäº§åŠ›</h4>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed">ä¸è¦ç›¸ä¿¡å”¾æ¶²ï¼é‚£å¹²å¾—å¤ªå¿«ä¸”ä¸å«ç”Ÿã€‚æ°´æº¶æ€§æ¶¦æ»‘æ¶²æ˜¯ä¸‡èƒ½çš„ç¥ã€‚å¦‚æœæ˜¯ç¡…èƒ¶ç©å…·ï¼Œåƒä¸‡åˆ«ç”¨ç¡…åŸºæ¶¦æ»‘æ¶²ï¼ˆä¼šäº’æº¶ï¼ï¼‰ï¼Œç”¨å®ƒå°±åƒåœ¨ç‚’èœæ—¶åŠ äº†502èƒ¶æ°´ã€‚</p>
                </div>

                <div class="glass-panel p-4 rounded-xl">
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fa-solid fa-soap text-pink-400 text-xl"></i>
                        <h4 class="font-bold text-pink-200">æ´—ç¢—ï¼ˆäº‹åï¼‰å¾ˆé‡è¦</h4>
                    </div>
                    <p class="text-sm text-gray-300 leading-relaxed">ç»“æŸåå¥³ç”Ÿå»ºè®®å»å˜˜å˜˜ä¸€ä¸‹ï¼Œå†²èµ°ç»†èŒé˜²å°¿è·¯æ„ŸæŸ“ã€‚ç®€å•å†²æ´—å³å¯ï¼Œä¸è¦çŒæ´—å†…éƒ¨ï¼Œé‚£é‡Œæœ‰è‡ªå·±çš„ç”Ÿæ€å¹³è¡¡ã€‚æŠ±åœ¨ä¸€èµ·è¯´è¯´è¯æ¯”ç›´æ¥ç¡è§‰æ›´èƒ½å¢åŠ äº²å¯†åº¦ã€‚</p>
                </div>

            </div>
        </div>

        <!-- 5. AI å®šåˆ¶ (Generator) -->
        <div id="view-ai" class="view-container view-hidden absolute inset-0 flex flex-col p-6 overflow-y-auto no-scrollbar">
            <div id="ai-input-step">
                <h3 class="cute-font text-xl mb-6 text-center text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-orange-300">âœ¨ AI æ–™ç†ç”Ÿæˆå™¨</h3>
                
                <div class="space-y-6">
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">ä»Šæ™šçš„å¿ƒæƒ… (Mood)</label>
                        <div class="flex gap-2">
                            <button onclick="selectMood(this, 'æ¸©é¦¨æµªæ¼«')" class="mood-btn flex-1 glass-btn py-3 rounded-lg text-sm hover:bg-pink-500/30 transition">ğŸ’– æ¸©é¦¨</button>
                            <button onclick="selectMood(this, 'æ¿€æƒ…ç‹‚é‡')" class="mood-btn flex-1 glass-btn py-3 rounded-lg text-sm hover:bg-red-500/30 transition">ğŸ”¥ ç‹‚é‡</button>
                            <button onclick="selectMood(this, 'æ¢ç´¢æ–°å¥‡')" class="mood-btn flex-1 glass-btn py-3 rounded-lg text-sm hover:bg-purple-500/30 transition">ğŸ² å¥½å¥‡</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">ç²¾åŠ›å€¼ (Energy)</label>
                        <input type="range" id="energy-range" min="1" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-pink-500">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>ç´¯ç˜«äº†</span>
                            <span>ç²¾åŠ›å……æ²›</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-gray-400 uppercase tracking-wider mb-2 block">é™„åŠ è¦æ±‚ (Optional)</label>
                        <input type="text" id="ai-prompt-extra" class="w-full input-glass p-3 rounded-lg text-sm" placeholder="ä¾‹å¦‚ï¼šæƒ³å¬çˆµå£«ä¹ï¼Œä¸è¦å¤ªç´¯...">
                    </div>

                    <button onclick="generatePlan()" class="w-full py-4 mt-4 bg-gradient-to-r from-pink-600 to-purple-600 rounded-xl font-bold shadow-lg shadow-pink-500/20 active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-utensils"></i> ç”Ÿæˆä»Šæ—¥èœå•
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div id="ai-loading" class="hidden flex-col items-center justify-center h-full pt-20">
                <div class="w-16 h-16 border-4 border-pink-500/30 border-t-pink-500 rounded-full animate-spin mb-4"></div>
                <p class="text-sm text-pink-300 animate-pulse">å…”å­ä¸»å¨æ­£åœ¨ç¿»é˜…ç§˜ç±...</p>
            </div>

            <!-- Result -->
            <div id="ai-result" class="hidden pt-2 pb-10">
                <button onclick="resetAI()" class="mb-4 text-xs text-gray-400 flex items-center gap-1"><i class="fa-solid fa-arrow-left"></i> é‡æ¥</button>
                <div class="glass-panel p-5 rounded-2xl border-t-4 border-pink-500">
                    <h2 id="plan-title" class="text-xl cute-font text-white mb-4"></h2>
                    <div id="plan-content" class="text-sm text-gray-200 leading-7 space-y-4 markdown-body"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨æ’­æ”¾æ¡ (Mini Player) -->
    <div id="mini-player" class="h-14 bg-gray-900/80 backdrop-blur-md border-t border-white/5 flex items-center px-4 justify-between shrink-0 translate-y-full transition-transform duration-500">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gray-700 animate-pulse flex items-center justify-center"><i class="fa-solid fa-music text-[10px]"></i></div>
            <div class="text-xs">
                <div class="text-gray-400">æ­£åœ¨æ’­æ”¾</div>
                <div class="font-bold text-pink-300" id="mini-track-name">Unknown</div>
            </div>
        </div>
        <button onclick="stopMusic()" class="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center hover:bg-white/20"><i class="fa-solid fa-stop text-xs"></i></button>
    </div>

</div>

<script>
    // === æ•°æ®ä¸é…ç½® ===
    let selectedMood = '';
    let API_KEY = localStorage.getItem('love_bistro_key') || '';
    const API_URL = "https://api.deepseek.com/chat/completions";

    // é¢„è®¾é£Ÿè°± (Recipes)
    const recipes = [
        { title: "ä¼ ç»Ÿçš„ç™½ç±³é¥­", tag: "easy", icon: "ğŸ¥£", desc: "æœ€ç»å…¸çš„ä¼ æ•™å£«ä½“ä½ã€‚é¢å¯¹é¢ï¼Œçœ¼ç¥äº¤æµæ»¡åˆ†ã€‚é€‚åˆæƒ³å¥½å¥½è¯´è¯çš„æ—¶å€™ã€‚", energy: 3 },
        { title: "æ‡’äººå‹ºå­æ±¤", tag: "easy", icon: "ğŸ¥„", desc: "ä¾§å§å‹ºå­å¼ã€‚ä¸¤äººéƒ½ä¾§èººï¼ŒçœåŠ›ç¬¬ä¸€åã€‚é€‚åˆç´¯äº†ä¸€å¤©ä½†æƒ³è´´è´´çš„å¤œæ™šã€‚", energy: 1 },
        { title: "é¤æ¡Œä¸Šçš„é£æ™¯", tag: "hard", icon: "ğŸª‘", desc: "æŠŠå¯¹æ–¹æŠ±åœ¨æ¡Œå­æˆ–é«˜å°ä¸Šã€‚è™½ç„¶åˆºæ¿€ï¼Œä½†è¦æ³¨æ„è…°å’Œå®¶å…·çš„æ‰¿é‡å“¦ã€‚", energy: 5 },
        { title: "å°ç‹—å¼", tag: "medium", icon: "ğŸ•", desc: "ç»å…¸çš„åå…¥å¼ã€‚æ·±å…¥ä¸”ç‹‚é‡ï¼Œä½†å°‘äº†çœ¼ç¥äº¤æµã€‚å¯ä»¥ç”¨æ‰‹æŠšæ‘¸èƒŒéƒ¨å¢åŠ è¿æ¥æ„Ÿã€‚", energy: 4 },
        { title: "å¥³éª‘å£«çš„è¿œå¾", tag: "medium", icon: "ğŸ‡", desc: "å¥³ä¸Šç”·ä¸‹ã€‚æŠŠæ§åˆ¶æƒäº¤ç»™å¥³ç”Ÿï¼Œç”·ç”Ÿè´Ÿè´£èººå¹³æ¬£èµï¼ˆå’Œè¾…åŠ©ï¼‰ã€‚", energy: 4 },
        { title: "è²èŠ±åº§ç›˜é¢", tag: "medium", icon: "ğŸ§˜", desc: "é¢å¯¹é¢åç€ç»“åˆã€‚æåº¦äº²å¯†ï¼Œå¯ä»¥æ¥å»ã€æ‹¥æŠ±ï¼Œä»¿ä½›èä¸ºä¸€ä½“ã€‚", energy: 2 }
    ];

    // === åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
        if(API_KEY) document.getElementById('api-key').value = API_KEY;
        renderRecipes('all');
    });

    // === è§†å›¾åˆ‡æ¢ ===
    function switchView(viewId) {
        document.querySelectorAll('.view-container').forEach(el => {
            el.classList.remove('view-active');
            el.classList.add('view-hidden');
        });
        document.getElementById(viewId).classList.remove('view-hidden');
        document.getElementById(viewId).classList.add('view-active');
    }
    function goHome() { switchView('view-home'); }

    // === éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘ ===
    let isPlaying = false;
    const audio = document.getElementById('audio-player');
    // æ¨¡æ‹ŸéŸ³é¢‘é“¾æ¥ (ä½¿ç”¨å…è´¹éŸ³æ•ˆåº“é“¾æ¥ï¼Œæˆ–è€…ä»…åšè§†è§‰æ¨¡æ‹Ÿ)
    const tracks = {
        'rnb': { name: "R&B: æš§æ˜§å¾®é†º", src: "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3" }, // Placeholder
        'jazz': { name: "Jazz: çƒ›å…‰æ™šé¤", src: "https://cdn.pixabay.com/download/audio/2022/03/24/audio_01267b2864.mp3" }, // Placeholder
        'lofi': { name: "Lo-Fi: è´¤è€…æ—¶é—´", src: "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3" } // Placeholder
    };

    function playMusic(type) {
        const track = tracks[type];
        const record = document.getElementById('vinyl-record');
        const arm = document.getElementById('tone-arm');
        const vis = document.getElementById('visualizer');
        const bars = document.querySelectorAll('.bar');
        
        // UI æ›´æ–°
        document.getElementById('track-name').innerText = track.name;
        document.getElementById('mini-track-name').innerText = track.name;
        
        // åŠ¨ç”»çŠ¶æ€
        record.classList.remove('spin-paused');
        arm.style.transform = 'rotate(25deg)'; // å”±è‡‚ç§»å…¥
        vis.style.opacity = '1';
        bars.forEach(b => b.classList.add('bar-playing'));
        document.getElementById('mini-player').style.transform = 'translateY(0)';

        // éŸ³é¢‘å¤„ç†
        audio.src = track.src;
        audio.volume = 0.5;
        audio.play().catch(e => console.log("Auto-play prevented"));
        isPlaying = true;
    }

    function stopMusic() {
        const record = document.getElementById('vinyl-record');
        const arm = document.getElementById('tone-arm');
        const vis = document.getElementById('visualizer');
        const bars = document.querySelectorAll('.bar');

        record.classList.add('spin-paused');
        arm.style.transform = 'rotate(-30deg)'; // å”±è‡‚ç§»å‡º
        vis.style.opacity = '0';
        bars.forEach(b => b.classList.remove('bar-playing'));
        document.getElementById('mini-player').style.transform = 'translateY(100%)';
        
        audio.pause();
        isPlaying = false;
    }

    // === é£Ÿè°±é€»è¾‘ ===
    function renderRecipes(filter) {
        const list = document.getElementById('recipe-list');
        list.innerHTML = '';
        recipes.forEach(r => {
            if(filter !== 'all' && (filter === 'easy' && r.energy > 3)) return;
            if(filter !== 'all' && (filter === 'hard' && r.energy <= 3)) return;
            
            // èƒ½é‡æ¡æ¸²æŸ“
            let stars = '';
            for(let i=0; i<5; i++) stars += i < r.energy ? 'âš¡' : '<span class="opacity-20">âš¡</span>';

            const card = document.createElement('div');
            card.className = "glass-panel p-4 rounded-xl flex items-start gap-4 hover:bg-white/5 transition";
            card.innerHTML = `
                <div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center text-2xl shrink-0">${r.icon}</div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-pink-200">${r.title}</h4>
                        <span class="text-[10px] tracking-tighter">${stars}</span>
                    </div>
                    <p class="text-xs text-gray-300 leading-relaxed">${r.desc}</p>
                </div>
            `;
            list.appendChild(card);
        });
    }

    function filterRecipe(type) { renderRecipes(type); }

    // === AI é€»è¾‘ ===
    function selectMood(btn, mood) {
        document.querySelectorAll('.mood-btn').forEach(b => {
            b.classList.remove('bg-white/20', 'border-white');
        });
        btn.classList.add('bg-white/20', 'border', 'border-white');
        selectedMood = mood;
    }

    async function generatePlan() {
        const energy = document.getElementById('energy-range').value;
        const extra = document.getElementById('ai-prompt-extra').value;
        
        if(!selectedMood) { alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…~ ğŸ‡"); return; }

        document.getElementById('ai-input-step').classList.add('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-loading').classList.add('flex');

        // æ„å»ºæç¤ºè¯
        const prompt = `ä½ æ˜¯ä¸€ä¸ªæµªæ¼«ä¸”å¹½é»˜çš„"æ·±å¤œé£Ÿå ‚"ä¸»å¨(ä¹Ÿæ˜¯æ€§çˆ±é¡¾é—®)ã€‚ç”¨æˆ·ä»Šæ™šå¿ƒæƒ…:${selectedMood}ï¼Œç²¾åŠ›å€¼:${energy}%(100æ˜¯æ»¡ç²¾åŠ›)ï¼Œé™„åŠ éœ€æ±‚:${extra}ã€‚è¯·ç”¨"æ–™ç†"çš„éšå–»(æŠŠæ€§çˆ±æ¯”ä½œåšé¥­)ç”Ÿæˆä¸€ä»½èœå•ã€‚
        è¿”å›JSONæ ¼å¼:
        {
            "title": "èœå (å¦‚: æ…µæ‡’å¥¶æ²¹ç‚–èœ)",
            "content": "Markdownæ ¼å¼çš„å†…å®¹ã€‚åŒ…æ‹¬: \n1. å‰èœå»ºè®® (å‰æˆã€æ°›å›´ã€éŸ³ä¹)\n2. ä¸»èœæ¨è (å§¿åŠ¿ã€åŠ¨ä½œå»ºè®®)\n3. ç”œç‚¹ (äº‹åæ¸©å­˜)\nè¯­æ°”è¦å¯çˆ±ã€æ’©äººã€å®‰å…¨ç§‘æ™®ï¼Œä¸è¦å¤ªéœ²éª¨ä½†è¦å®ç”¨ã€‚"
        }`;

        try {
            let data;
            if(API_KEY) {
                // æœ‰ API Keyï¼Œè°ƒç”¨ DeepSeek
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{role:"system", content:"Output JSON only."}, {role:"user", content:prompt}],
                        stream: false
                    })
                });
                const json = await res.json();
                const content = json.choices[0].message.content.replace(/```json/g,"").replace(/```/g,"").trim();
                data = JSON.parse(content);
            } else {
                // æ—  API Keyï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                await new Promise(r => setTimeout(r, 2000)); // å‡è£…æ€è€ƒ
                data = mockAIResponse(selectedMood, energy);
            }
            
            showPlan(data);
        } catch(e) {
            console.error(e);
            alert("ä¸»å¨å¤ªå¿™äº†ï¼Œè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ API Keyï¼");
            resetAI();
        }
    }

    function mockAIResponse(mood, energy) {
        // æœ¬åœ°é™çº§æ–¹æ¡ˆ
        let title = "ä»Šæ—¥ç‰¹ä¾›ï¼š";
        let content = "";
        
        if(energy < 30) {
            title += "æ…µæ‡’èˆ’èŠ™è•¾";
            content = `
**ğŸµ æ°›å›´ï¼š** å»ºè®®æ’­æ”¾ Lo-Fi æ­Œå•ï¼Œç¯å…‰è°ƒåˆ°æœ€æš—ã€‚
\n**ğŸ¥— å‰èœï¼š** ä¸éœ€è¦å¤æ‚çš„å‡†å¤‡ï¼Œäº’ç›¸æŒ‰æ‘©è‚©è†€å’ŒèƒŒéƒ¨ï¼Œç”¨ç²¾æ²¹æ…¢æ…¢æ¨å¼€ç–²æƒ«ã€‚
\n**ğŸ¥˜ ä¸»èœï¼š** æ¨è **ã€Œä¾§å§å‹ºå­å¼ã€**ã€‚ä¸¤ä¸ªäººéƒ½èººç€ï¼Œä¸ç”¨åŠ¨ä¹Ÿèƒ½æ„Ÿå—åˆ°å½¼æ­¤çš„æ¸©åº¦ã€‚æ…¢æ…¢æ¥ï¼Œä¸è¦æ€¥ç€ä¸Šå¤§ç«ã€‚
\n**ğŸ¨ ç”œç‚¹ï¼š** æŠ±åœ¨ä¸€èµ·åˆ«æ€¥ç€æ´—æ¾¡ï¼Œè¯´ä¸€å¥â€œè¾›è‹¦äº†â€ï¼Œç„¶åç›´æ¥å…¥ç¡ã€‚`;
        } else if (mood.includes("ç‹‚é‡")) {
            title += "è¾£å‘³çˆ†ç‚’å°ç‰›æŸ³";
            content = `
**ğŸµ æ°›å›´ï¼š** å¿…é¡»æ˜¯ R&B æˆ–è€…å¸¦ç‚¹èŠ‚å¥çš„ Jazzã€‚
\n**ğŸ¥— å‰èœï¼š** å¯ä»¥åœ¨å¨æˆ¿æˆ–å®¢å…å¼€å§‹ï¼ˆæ³¨æ„æ‹‰çª—å¸˜ï¼ï¼‰ã€‚è¯•ç€ç©ä¸€ç‚¹è§’è‰²æ‰®æ¼”ï¼Ÿ
\n**ğŸ¥˜ ä¸»èœï¼š** æ¨è **ã€Œå¥³éª‘å£«ã€** æˆ– **ã€Œæ¨è½¦å¼ã€**ã€‚é‡Šæ”¾æ‰€æœ‰çš„å‹åŠ›ï¼Œæ³¨æ„èŠ‚å¥çš„å˜åŒ–ã€‚
\n**ğŸ¨ ç”œç‚¹ï¼š** äº’ç›¸æ¸…ç†ï¼Œç„¶åå–æ¯æ¸©æ°´è¡¥å……æ°´åˆ†ã€‚`;
        } else {
            title += "æ¸©æ¶¦æ»‹è¡¥æ±¤";
            content = `
**ğŸµ æ°›å›´ï¼š** è½»æ¾çš„è“è°ƒã€‚
\n**ğŸ¥— å‰èœï¼š** å¤šä¸€ç‚¹äº²å»ï¼Œç‰¹åˆ«æ˜¯è„–å­å’Œè€³åã€‚
\n**ğŸ¥˜ ä¸»èœï¼š** æ¨è **ã€Œä¼ æ•™å£«å˜åŒ–ç‰ˆã€**ã€‚åœ¨è‡€éƒ¨å«ä¸€ä¸ªæ•å¤´ï¼Œä¼šæ‰“å¼€æ–°ä¸–ç•Œçš„å¤§é—¨å“¦ã€‚
\n**ğŸ¨ ç”œç‚¹ï¼š** ä¾ååœ¨ä¸€èµ·èŠèŠä¸‹å‘¨çš„è®¡åˆ’ã€‚`;
        }
        return { title, content };
    }

    function showPlan(data) {
        document.getElementById('ai-loading').classList.add('hidden');
        document.getElementById('ai-loading').classList.remove('flex');
        document.getElementById('ai-result').classList.remove('hidden');
        
        document.getElementById('plan-title').innerText = data.title;
        document.getElementById('plan-content').innerHTML = marked.parse(data.content);
        
        // æ’’èŠ±æ•ˆæœ
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#F472B6', '#fff', '#A78BFA'] });
    }

    function resetAI() {
        document.getElementById('ai-result').classList.add('hidden');
        document.getElementById('ai-input-step').classList.remove('hidden');
    }

    // === å…¶ä»–äº¤äº’ ===
    function pokeRabbit() {
        const bubble = document.getElementById('bubble');
        const msgs = ["è®°å¾—æˆ´å¥½é‚£ä¸ªå“¦ï¼", "ä»Šå¤©æƒ³åƒä»€ä¹ˆå£å‘³ï¼Ÿ", "å¤šå–æ°´ï¼", "æ¶¦æ»‘å¾ˆé‡è¦ï¼"];
        bubble.innerText = msgs[Math.floor(Math.random() * msgs.length)];
        bubble.style.opacity = '1';
        setTimeout(() => bubble.style.opacity = '0', 2000);
    }

    function toggleSettings() {
        document.getElementById('settings-panel').classList.toggle('hidden');
    }
    
    function saveSettings() {
        const val = document.getElementById('api-key').value;
        if(val) {
            API_KEY = val;
            localStorage.setItem('love_bistro_key', val);
            alert("ğŸ‘¨â€ğŸ³ å¨å¸ˆå·²å°±ä½ï¼");
            toggleSettings();
        }
    }
</script>
</body>
</html>